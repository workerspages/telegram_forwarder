name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ†• è°ƒè¯•æ­¥éª¤: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
      - name: Debug - List repository files
        run: |
          echo "=== Repository root files ==="
          ls -la
          echo ""
          echo "=== Source directory structure ==="
          find . -type f -name "*.py" -o -name "Dockerfile" -o -name "*.sh"
          echo ""
          if [ -d "src" ]; then
            echo "=== src/ directory contents ==="
            ls -la src/
          else
            echo "âš ï¸ WARNING: src/ directory not found!"
          fi

      # æ­¥éª¤2: ç™»å½•åˆ° GitHub Container Registry
      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤3: ç™»å½•åˆ° Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤4: æå– Docker å…ƒæ•°æ®
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
            ghcr.io/${{ github.repository }}

      # æ­¥éª¤5: è®¾ç½® Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ðŸ†• è°ƒè¯•æ­¥éª¤: åˆ›å»ºä¸´æ—¶è°ƒè¯• Dockerfile
      - name: Debug - Create debug Dockerfile
        run: |
          cat > Dockerfile.debug <<'EOF'
          FROM busybox
          COPY . /tmp/build/
          RUN echo "=== Files in build context ===" && \
              find /tmp/build/ -type f && \
              echo "" && \
              echo "=== Looking for telegram_to_email.py ===" && \
              find /tmp/build/ -name "telegram_to_email.py" || echo "âŒ telegram_to_email.py NOT FOUND"
          EOF

      # ðŸ†• è°ƒè¯•æ­¥éª¤: æž„å»ºè°ƒè¯•é•œåƒæŸ¥çœ‹æž„å»ºä¸Šä¸‹æ–‡
      - name: Debug - Build test image to check context
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.debug
          push: false
          tags: debug-context:latest

      # æ­¥éª¤6: æž„å»ºé•œåƒå¹¶æŽ¨é€
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
