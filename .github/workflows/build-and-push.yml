# å·¥ä½œæµçš„åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: Build and Push Docker Image

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  # å½“æœ‰ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ "main" ]
  # å…è®¸ä½ ä» Actions æ ‡ç­¾é¡µæ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

# å®šä¹‰ä¸€ä¸ªåä¸º "build-and-push" çš„ä½œä¸š
jobs:
  build-and-push:
    # æŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest

    # æˆäºˆ GITHUB_TOKEN å†™å…¥ ghcr.io çš„æƒé™
    permissions:
      contents: read
      packages: write

    # ä½œä¸šçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # ä½¿ç”¨å®˜æ–¹çš„ actions/checkout@v4 æ¥è·å–ä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤2: ç™»å½•åˆ° GitHub Container Registry (ghcr.io)
      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # github.actor æ˜¯è§¦å‘å·¥ä½œæµçš„ç”¨æˆ·å
          # secrets.GITHUB_TOKEN æ˜¯ç”± GitHub è‡ªåŠ¨æä¾›çš„ä»¤ç‰Œ
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤3: ç™»å½•åˆ° Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          # ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰åœ¨ GitHub Secrets ä¸­å­˜å‚¨çš„å‡­è¯
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤4: æå– Docker å…ƒæ•°æ® (é•œåƒåç§°å’Œæ ‡ç­¾)
      # è¿™ä¸ª action ä¼šè‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ï¼Œä¾‹å¦‚ 'latest', git-sha, etc.
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
            ghcr.io/${{ github.repository }}
          # github.event.repository.name æ˜¯ä»“åº“å
          # github.repository æ˜¯ 'ç”¨æˆ·å/ä»“åº“å'
          # ghcr.io è¦æ±‚é•œåƒåç§°ä¸ºå°å†™

      # æ­¥éª¤5: è®¾ç½® Buildx ä»¥ä¾¿åç»­ä½¿ç”¨
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # --- â†“â†“â†“ æˆ‘åœ¨è¿™é‡Œæ·»åŠ äº†æ–°çš„è°ƒè¯•æ­¥éª¤ â†“â†“â†“ ---
      - name: ğŸ§ Verify Filesystem Contents
        run: |
          echo "Listing all files in the repository..."
          ls -R
          echo "-------------------------------------"
          echo "Displaying Dockerfile contents..."
          cat Dockerfile
          echo "-------------------------------------"
      # --- â†‘â†‘â†‘ æ·»åŠ ç»“æŸ â†‘â†‘â†‘ ---

      # æ­¥éª¤6: æ„å»ºé•œåƒå¹¶æ¨é€åˆ°ä¸¤ä¸ªä»“åº“
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # æ„å»ºçš„ä¸Šä¸‹æ–‡ç›®å½• (é¡¹ç›®æ ¹ç›®å½•)
          context: .
          # æ¨é€é•œåƒåˆ°ä»“åº“
          push: true
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„æ ‡ç­¾
          tags: ${{ steps.meta.outputs.tags }}
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„æ ‡ç­¾
          labels: ${{ steps.meta.outputs.labels }}
           # --- â†“â†“â†“ æ·»åŠ è¿™ä¸€è¡Œä»¥ç¦ç”¨ç¼“å­˜ â†“â†“â†“ ---
           no-cache: true
